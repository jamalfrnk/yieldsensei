{% extends "base.html" %}
{% block content %}
<div class="space-y-6">
    <!-- Search Bar -->
    <div class="bg-gray-900 rounded-lg p-4">
        <form action="/search" method="GET" class="flex space-x-4">
            <input type="text" name="token" placeholder="Enter token symbol or contract address" 
                   class="flex-1 bg-black border border-orange-500 rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-orange-500">
            <button type="submit" class="bg-orange-500 text-white px-6 py-2 rounded hover:bg-orange-600 focus:outline-none focus:ring-2 focus:ring-orange-500">
                Analyze
            </button>
        </form>
    </div>

    {% if error %}
    <div class="bg-red-900 text-white rounded-lg p-4">
        {{ error }}
    </div>
    {% endif %}

    <!-- Market Overview -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="bg-gray-900 rounded-lg p-4 border border-orange-500 hover:bg-gray-800 transition-colors duration-200">
            <h3 class="text-lg font-semibold text-orange-500 mb-2">{{ token_symbol }}</h3>
            <p class="text-2xl mt-2">${{ "%.2f"|format(price|float) }}</p>
            <p class="text-sm text-gray-400">24h Change: 
                <span class="{% if price_change >= 0 %}text-green-500{% else %}text-red-500{% endif %}">
                    {{ "%.2f"|format(price_change|float) }}%
                </span>
            </p>
        </div>
        <div class="bg-gray-900 rounded-lg p-4 border border-orange-500 hover:bg-gray-800 transition-colors duration-200">
            <div class="flex items-center mb-2">
                <h3 class="text-lg font-semibold text-orange-500">Signal Strength</h3>
                <div class="ml-2 group relative">
                    <span class="cursor-help text-orange-500">ⓘ</span>
                    <div class="opacity-0 bg-black text-white text-sm rounded-lg py-2 px-3 absolute z-10 bottom-full mb-2 -left-1/2 pointer-events-none group-hover:opacity-100 transition-opacity duration-200 w-64">
                        A measure of how strong the trading signal is, based on multiple technical indicators including RSI, MACD, and price levels. Higher values indicate stronger signals.
                    </div>
                </div>
            </div>
            <p class="text-2xl mt-2">{{ "%.1f"|format(signal_strength|float) }}/100</p>
            <p class="text-sm text-gray-400">{{ signal_description }}</p>
        </div>
        <div class="bg-gray-900 rounded-lg p-4 border border-orange-500 hover:bg-gray-800 transition-colors duration-200">
            <div class="flex items-center mb-2">
                <h3 class="text-lg font-semibold text-orange-500">Trend Score</h3>
                <div class="ml-2 group relative">
                    <span class="cursor-help text-orange-500">ⓘ</span>
                    <div class="opacity-0 bg-black text-white text-sm rounded-lg py-2 px-3 absolute z-10 bottom-full mb-2 -left-1/2 pointer-events-none group-hover:opacity-100 transition-opacity duration-200 w-64">
                        A score from 0-100 indicating the strength and direction of the current market trend. Higher scores suggest stronger upward trends, while lower scores indicate stronger downward trends.
                    </div>
                </div>
            </div>
            <p class="text-2xl mt-2">{{ "%.2f"|format(trend_score|float) }}/100</p>
            <p class="text-sm text-gray-400">{{ trend_direction }}</p>
        </div>
        <div class="bg-gray-900 rounded-lg p-4 border border-orange-500 hover:bg-gray-800 transition-colors duration-200">
            <div class="flex items-center mb-2">
                <h3 class="text-lg font-semibold text-orange-500">Market Status</h3>
                <div class="ml-2 group relative">
                    <span class="cursor-help text-orange-500">ⓘ</span>
                    <div class="opacity-0 bg-black text-white text-sm rounded-lg py-2 px-3 absolute z-10 bottom-full mb-2 -left-1/2 pointer-events-none group-hover:opacity-100 transition-opacity duration-200 w-64">
                        Indicates whether the market is overbought (RSI > 70), oversold (RSI < 30), or neutral. This helps identify potential reversal points and market extremes.
                    </div>
                </div>
            </div>
            <p class="text-2xl mt-2">{{ market_status }}</p>
            <p class="text-sm text-gray-400">RSI: {{ "%.1f"|format(rsi|float) }}</p>
        </div>
    </div>

    <!-- Price Levels -->
    <div class="bg-gray-900 rounded-lg p-4">
        <h2 class="text-xl font-bold text-orange-500 mb-4">Price Levels</h2>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            <div class="relative" style="height: 400px;">
                <canvas id="priceChart"></canvas>
            </div>
            <div class="relative" style="height: 400px;">
                <canvas id="metricsChart"></canvas>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Price Line Chart
        const priceCtx = document.getElementById('priceChart').getContext('2d');
        const metricsCtx = document.getElementById('metricsChart').getContext('2d');
        const chartData = {{ chart_data|tojson }};

        if (!chartData || !chartData.labels || !chartData.prices) {
            console.error('Invalid chart data:', chartData);
            return;
        }

        // Format dates for x-axis
        const labels = chartData.labels.map(timestamp => {
            return new Date(timestamp).toLocaleDateString();
        });

        // Create gradient for line
        const gradient = priceCtx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, 'rgba(249, 115, 22, 0.4)');
        gradient.addColorStop(1, 'rgba(249, 115, 22, 0)');

        const support1 = chartData.support_levels[0];
        const support2 = chartData.support_levels[1];
        const resistance1 = chartData.resistance_levels[0];
        const resistance2 = chartData.resistance_levels[1];

        // Create the price chart
        window.priceChart = new Chart(priceCtx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Price',
                        data: chartData.prices,
                        borderColor: 'rgb(249, 115, 22)',
                        backgroundColor: gradient,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 2,
                        pointHoverRadius: 5,
                        borderWidth: 2
                    },
                    {
                        label: `Support 1 ($${support1.toLocaleString()})`,
                        data: Array(labels.length).fill(support1),
                        borderColor: 'rgb(50, 205, 50)',
                        borderDash: [5, 5],
                        fill: false,
                        borderWidth: 2,
                        pointRadius: 0
                    },
                    {
                        label: `Support 2 ($${support2.toLocaleString()})`,
                        data: Array(labels.length).fill(support2),
                        borderColor: 'rgb(0, 100, 0)',
                        borderDash: [5, 5],
                        fill: false,
                        borderWidth: 2,
                        pointRadius: 0
                    },
                    {
                        label: `Resistance 1 ($${resistance1.toLocaleString()})`,
                        data: Array(labels.length).fill(resistance1),
                        borderColor: 'rgb(255, 99, 99)',
                        borderDash: [5, 5],
                        fill: false,
                        borderWidth: 2,
                        pointRadius: 0
                    },
                    {
                        label: `Resistance 2 ($${resistance2.toLocaleString()})`,
                        data: Array(labels.length).fill(resistance2),
                        borderColor: 'rgb(255, 0, 0)',
                        borderDash: [5, 5],
                        fill: false,
                        borderWidth: 2,
                        pointRadius: 0
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        ticks: {
                            color: '#FFF',
                            callback: function(value) {
                                return '$' + value.toLocaleString();
                            }
                        }
                    },
                    x: {
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        ticks: {
                            color: '#FFF',
                            maxRotation: 45,
                            minRotation: 45
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            color: '#FFF',
                            usePointStyle: true,
                            padding: 20,
                            font: {
                                size: 12
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.9)',
                        titleColor: '#F97316',
                        bodyColor: '#FFFFFF',
                        padding: 12,
                        displayColors: true,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += '$' + context.parsed.y.toLocaleString();
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });

        // Create the metrics bar chart
        window.metricsChart = new Chart(metricsCtx, {
            type: 'bar',
            data: {
                labels: ['Signal Strength', 'Trend Score', 'RSI'],
                datasets: [{
                    label: 'Market Metrics',
                    data: [
                        {{ signal_strength }},
                        {{ trend_score }},
                        {{ rsi }}
                    ],
                    backgroundColor: [
                        'rgba(249, 115, 22, 0.7)',  // Orange
                        'rgba(50, 205, 50, 0.7)',   // Green
                        'rgba(59, 130, 246, 0.7)'   // Blue
                    ],
                    borderColor: [
                        'rgb(249, 115, 22)',
                        'rgb(50, 205, 50)',
                        'rgb(59, 130, 246)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        ticks: {
                            color: '#FFF'
                        }
                    },
                    x: {
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        ticks: {
                            color: '#FFF'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            color: '#FFF',
                            font: {
                                size: 12
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.9)',
                        titleColor: '#F97316',
                        bodyColor: '#FFFFFF',
                        padding: 12,
                        displayColors: true
                    }
                }
            }
        });
    });
    </script>

    <!-- Support/Resistance Levels and Trading Strategy -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="bg-gray-900 rounded-lg p-4">
            <h2 class="text-xl font-bold text-orange-500 mb-4">Key Levels</h2>
            <div class="space-y-2">
                <div class="flex justify-between items-center p-2 hover:bg-gray-800 rounded transition-colors duration-200">
                    <span>Resistance 2:</span>
                    <span class="text-red-500">${{ "%.2f"|format(resistance_2|float) }}</span>
                </div>
                <div class="flex justify-between items-center p-2 hover:bg-gray-800 rounded transition-colors duration-200">
                    <span>Resistance 1:</span>
                    <span class="text-red-400">${{ "%.2f"|format(resistance_1|float) }}</span>
                </div>
                <div class="flex justify-between items-center p-2 hover:bg-gray-800 rounded transition-colors duration-200">
                    <span>Current Price:</span>
                    <span class="text-white">${{ "%.2f"|format(price|float) }}</span>
                </div>
                <div class="flex justify-between items-center p-2 hover:bg-gray-800 rounded transition-colors duration-200">
                    <span>Support 1:</span>
                    <span class="text-green-400">${{ "%.2f"|format(support_1|float) }}</span>
                </div>
                <div class="flex justify-between items-center p-2 hover:bg-gray-800 rounded transition-colors duration-200">
                    <span>Support 2:</span>
                    <span class="text-green-500">${{ "%.2f"|format(support_2|float) }}</span>
                </div>
            </div>
        </div>

        <!-- Trading Strategy -->
        <div class="bg-gray-900 rounded-lg p-4">
            <div class="flex items-center mb-4">
                <h2 class="text-xl font-bold text-orange-500">Trading Strategy</h2>
                <div class="ml-2 group relative">
                    <span class="cursor-help text-orange-500">ⓘ</span>
                    <div class="opacity-0 bg-black text-white text-sm rounded-lg py-2 px-3 absolute z-10 bottom-full mb-2 -left-1/2 pointer-events-none group-hover:opacity-100 transition-opacity duration-200 w-64">
                        Personalized trading recommendations based on current market conditions, technical analysis, and risk management principles. These strategies suggest optimal entry points and position sizing using Dollar Cost Averaging (DCA).
                    </div>
                </div>
            </div>
            <div class="space-y-4">
                <div class="bg-black bg-opacity-50 p-3 rounded">
                    <h3 class="text-orange-500 font-semibold mb-2">Trade Recommendation:</h3>
                    <p class="text-sm whitespace-pre-line mb-4">{{ dca_recommendation }}</p>
                </div>
                <div class="bg-black bg-opacity-50 p-3 rounded">
                    <h3 class="text-orange-500 font-semibold mb-2">Entry Strategy:</h3>
                    <p>Optimal Entry: ${{ "%.2f"|format(optimal_entry|float) }}</p>
                    <p>Stop Loss: ${{ "%.2f"|format(stop_loss|float) }}</p>
                </div>
                <div class="bg-black bg-opacity-50 p-3 rounded">
                    <h3 class="text-orange-500 font-semibold mb-2">Exit Strategy:</h3>
                    <p>Take Profit: ${{ "%.2f"|format(optimal_exit|float) }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Telegram Bot Integration -->
    <div class="bg-gray-900 rounded-lg p-4 mt-6">
        <h2 class="text-xl font-bold text-orange-500 mb-4">Get More with YieldSensei Bot</h2>
        <p class="text-gray-300 mb-4">Access these features and more through our Telegram bot:</p>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div class="p-4 bg-black rounded-lg border border-orange-500">
                <h3 class="text-lg font-semibold text-orange-500 mb-2">Real-time Signals</h3>
                <p class="text-sm text-gray-400">Get instant trading signals with /signal command</p>
            </div>
            <div class="p-4 bg-black rounded-lg border border-orange-500">
                <h3 class="text-lg font-semibold text-orange-500 mb-2">Market Data</h3>
                <p class="text-sm text-gray-400">Check market stats with /market command</p>
            </div>
            <div class="p-4 bg-black rounded-lg border border-orange-500">
                <h3 class="text-lg font-semibold text-orange-500 mb-2">DEX Analytics</h3>
                <p class="text-sm text-gray-400">Analyze DEX pairs with /dexinfo command</p>
            </div>
        </div>
        <div class="mt-6 text-center">
            <a href="https://t.me/yieldsensei_bot" target="_blank" 
               class="inline-block bg-orange-500 text-white px-8 py-3 rounded-lg hover:bg-orange-600 transition-colors duration-200">
                Open Telegram Bot
            </a>
        </div>
    </div>
</div>

{% endblock %}