<div class="bg-gray-900 rounded-lg p-4 border border-orange-500 hover:bg-gray-800 transition-colors duration-200 mt-6">
    <div class="flex items-center mb-4">
        <h3 class="text-xl font-semibold text-orange-500">Market Sentiment Heatmap</h3>
        <div class="ml-2 group relative">
            <span class="cursor-help text-orange-500">â“˜</span>
            <div class="opacity-0 bg-black text-white text-sm rounded-lg py-2 px-3 absolute z-10 bottom-full mb-2 -left-1/2 pointer-events-none group-hover:opacity-100 transition-opacity duration-200 w-64">
                Visual representation of market sentiment across different cryptocurrencies. Darker green indicates stronger bullish sentiment, while darker red indicates stronger bearish sentiment.
            </div>
        </div>
    </div>
    <div id="market-heatmap" class="w-full h-64 relative">
        <div id="heatmap-loading" class="hidden absolute inset-0 flex items-center justify-center bg-gray-900 bg-opacity-75">
            <div class="text-orange-500">Loading market data...</div>
        </div>
    </div>
</div>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
    function showLoading() {
        document.getElementById('heatmap-loading').classList.remove('hidden');
    }

    function hideLoading() {
        document.getElementById('heatmap-loading').classList.add('hidden');
    }

    function updateHeatmap(data) {
        const margin = { top: 10, right: 10, bottom: 30, left: 100 };
        const width = document.getElementById('market-heatmap').clientWidth - margin.left - margin.right;
        const height = document.getElementById('market-heatmap').clientHeight - margin.top - margin.bottom;

        // Clear previous content
        d3.select("#market-heatmap").html("");

        const svg = d3.select("#market-heatmap")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        // Create color scale
        const colorScale = d3.scaleLinear()
            .domain([0, 50, 100])
            .range(["#ef4444", "#d1d5db", "#22c55e"]);

        // Create rectangles
        svg.selectAll("rect")
            .data(data)
            .enter()
            .append("rect")
            .attr("x", 0)
            .attr("y", (d, i) => i * (height / data.length))
            .attr("width", width)
            .attr("height", height / data.length)
            .attr("fill", d => colorScale(d.sentiment_score))
            .attr("rx", 4)
            .attr("ry", 4);

        // Add token symbols
        svg.selectAll("text")
            .data(data)
            .enter()
            .append("text")
            .attr("x", -10)
            .attr("y", (d, i) => i * (height / data.length) + (height / data.length) / 2)
            .attr("text-anchor", "end")
            .attr("dominant-baseline", "middle")
            .attr("fill", "#e5e7eb")
            .text(d => d.symbol.toUpperCase());

        // Add sentiment scores and emojis
        svg.selectAll(".score")
            .data(data)
            .enter()
            .append("text")
            .attr("class", "score")
            .attr("x", width / 2)
            .attr("y", (d, i) => i * (height / data.length) + (height / data.length) / 2)
            .attr("text-anchor", "middle")
            .attr("dominant-baseline", "middle")
            .attr("fill", "#e5e7eb")
            .text(d => `${d.sentiment_score.toFixed(1)} ${d.emoji}`);
    }

    // Update heatmap every 30 seconds
    async function fetchAndUpdateHeatmap() {
        showLoading();
        try {
            const response = await fetch('/api/market_sentiment');
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            const data = await response.json();
            if (data && data.length > 0) {
                updateHeatmap(data);
            } else {
                console.warn('No sentiment data available');
            }
        } catch (error) {
            console.error('Error fetching market sentiment:', error);
        } finally {
            hideLoading();
        }
    }

    // Initial update
    fetchAndUpdateHeatmap();

    // Set up periodic updates
    setInterval(fetchAndUpdateHeatmap, 30000);
</script>